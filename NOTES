# -*- org -*-
#+Title: Sorting in different algorithms and languages
#+Author: Eric Schulte

* Compilation
| c   | gcc -S <asm> <src>    |
| cpp | g++ -S <asm> <src>    |
| hs  | ghc -S <asm> <src>    |
| ml  | ocamlc -o             |
| fs  | see [[http://concatenative.org/wiki/view/Factor/Deployment][Factor/Deployment]] |

This [[http://factor-language.blogspot.com/2010/05/comparing-factors-performance-against.html][blog post]] has some information on compiling executable from sbcl
and factor.

** asm
#+begin_src sh
  #!/bin/bash
  TMP=`echo $3|sed 's/\(.*\)\..*/\1/'`
  as -o $TMP.o $3 && \
      ld $TMP.o -o $2 && \
      rm -f $TMP.o
#+end_src

** ocaml
good discussion of Ocaml types with lots of example assembly
http://www.ocaml-tutorial.org/performance_and_profiling

1) first generate the required .s and startup files
   : ocamlopt -dstartup -S bubble.ml
2) then find out what flags ocamlopt is passing to gcc
   : ocamlopt -verbose -o bub1 bubble.ml
3) call gcc on the startup and .s file, as well as the ocaml libraries
   copied from the verbose output of ocamlopt -verbose, e.g. 
   : gcc -o bub '-L/usr/lib/ocaml' 'a.out.startup.s' '/usr/lib/ocaml/std_exit.o' 'bubble.s' '/usr/lib/ocaml/stdlib.a' '/usr/lib/ocaml/libasmrun.a' -lm  -ldl

#+begin_src sh :shebang=#!/bin/bash :tangle fake-gcc
  gcc -o $2 '-L/usr/lib/ocaml' '/home/eschulte/research/epr/asm/sorters/sort-rb/src/insertion-ml.startup.s' '/usr/lib/ocaml/std_exit.o' $3 '/usr/lib/ocaml/stdlib.a' '/usr/lib/ocaml/libasmrun.a' -lm  -ldl
#+end_src

** sbcl
This recipe works, although I'm not sure it counts as an executable
1) compile the lisp file into a .core file
   : sbcl --userinit /dev/null --load bubble.sbcl_compile
2) run the core file
   : sbcl --dynamic-space-size 500 --noinform --core bubble.core --userinit /dev/null --load bubble.sbcl_run

#+begin_src lisp
  (handler-bind
   ((sb-ext:defconstant-uneql (lambda (c) (abort c))))
   (load (compile-file "nbody.sbcl" )))
  (save-lisp-and-die "nbody.core" :purify t)
#+end_src
#+begin_src sh
  ln -s ~/perf/shootout/bench/nbody/nbody.sbcl .
  
  cat > nbody.sbcl_compile <<EOF
  (proclaim '(optimize (speed 3) (safety 0) (debug 0) (compilation-speed 0) (space 0)))
  (handler-bind ((sb-ext:defconstant-uneql (lambda (c) (abort c))))
    (load (compile-file "nbody.sbcl" )))
  (save-lisp-and-die "nbody.core" :purify t)
  EOF
  
  sbcl --userinit /dev/null --load nbody.sbcl_compile
  
  cat > nbody.sbcl_run <<EOF
  (proclaim '(optimize (speed 3) (safety 0) (debug 0) (compilation-speed 0) (space 0)))
  (main) (quit)
  EOF
  
  time sbcl --dynamic-space-size 500 --noinform --core nbody.core --userinit /dev/null --load nbody.sbcl_run 1000000
#+end_src
** racket
http://docs.racket-lang.org/raco/exe.html

can be done with some subset of the racket executable
: raco exe bubble.rkt

** lua -- can be done through C
http://stackoverflow.com/questions/194520/creating-standalone-lua-executables
: luac script.lua -o script.luac
: bin2c script.luac > code.c
* Tasks [1/2]
** DONE Analyze unreliable results
*** Table
#+begin_src sh :dir results/unreliable/ :cache yes
  MEAN_CMD='{
    for (i=1; i<=NF; i++)
    {
        if($i ~ /[0-9.]/){sum[i] += $i; count[i]++}
        if(i == 1){ line = sum[i]/count[i] }else{ line = line " " sum[i]/count[i]}
    }
    print line
  }'
  ZERO_CMD='{zeros=0; for(i=1;i<=NF; i++){if($i == 0){zeros++;}}; print (zeros * 10);}'
  WRONG_CMD='{wrongs=0; for(i=1;i<=NF; i++){if($i > 0){wrongs++;}}; print (wrongs * 10);}'
  ERROR_CMD='{errors=0; for(i=1;i<=NF; i++){if($i < 0){errors++;}}; print (errors * 10);}'
  
  GRADATIONS=(0 0.001 0.0025 0.005 0.0075 0.01 0.025 0.05 0.075 0.1 0.25 0.5 0.75 1)
  
  echo -ne "\t\t\t"
  for ur in ${GRADATIONS[@]};do
      echo -ne "$ur%\t\t\t"
  done
  echo ""
  echo -ne "alg\tflag\tcmps"
  for ur in ${GRADATIONS[@]};do
      echo -ne "\tcorrect\twrong\terror"
  done
  echo ""
  for alg in bubble insertion merge quick;do
      for flag in Os O0 O1 O2 O3 Ofast;do
          ASM=_${alg}_c_gcc_${flag}.s
          COUNT=$(grep -c $'^\tcmp' $ASM)
          echo -ne "$alg\t$flag\t$COUNT"
          for ur in ${GRADATIONS[@]};do
              TEST=_${alg}_c_gcc_${flag}_ur_${ur}.test
              CORRECT=$(head -100 $TEST|awk "$ZERO_CMD"|awk "$MEAN_CMD"|tail -1)
              echo -ne "\t$CORRECT%"
              WRONG=$(head -100 $TEST|awk "$WRONG_CMD"|awk "$MEAN_CMD"|tail -1)
              echo -ne "\t$WRONG%"
              ERROR=$(head -100 $TEST|awk "$ERROR_CMD"|awk "$MEAN_CMD"|tail -1)
              echo -ne "\t$ERROR%"
          done
          echo ""
      done
  done
#+end_src

#+Caption: Average correct and failed sorting runs by % unreliable assembler comparisons.
#+RESULTS[963a48465bb23b0992fc267dde55cc5a96d607ea]:
|           |       |      |      0% |       |       |  0.001% |       |       | 0.0025% |       |       |  0.005% |       |       | 0.0075% |       |       |   0.01% |       |       |  0.025% |       |       |   0.05% |       |       |  0.075% |       |       |    0.1% |       |       |   0.25% |       |       |    0.5% |       |       |   0.75% |       |       |      1% |       |       |
|-----------+-------+------+---------+-------+-------+---------+-------+-------+---------+-------+-------+---------+-------+-------+---------+-------+-------+---------+-------+-------+---------+-------+-------+---------+-------+-------+---------+-------+-------+---------+-------+-------+---------+-------+-------+---------+-------+-------+---------+-------+-------+---------+-------+-------|
| alg       | flag  | cmps | correct | wrong | error | correct | wrong | error | correct | wrong | error | correct | wrong | error | correct | wrong | error | correct | wrong | error | correct | wrong | error | correct | wrong | error | correct | wrong | error | correct | wrong | error | correct | wrong | error | correct | wrong | error | correct | wrong | error | correct | wrong | error |
| bubble    | Os    |    4 |      8% |    0% |   92% |   16.7% |  3.4% | 79.9% |   20.2% |  5.1% | 74.7% |   20.9% | 12.1% |   67% |   21.2% | 16.7% | 62.1% |   21.7% | 19.3% |   59% |   22.9% | 39.3% | 37.8% |   24.6% | 50.5% | 24.9% |   24.2% | 59.8% |   16% |   22.3% | 63.8% | 13.9% |     18% | 56.4% | 25.6% |    8.8% | 43.2% |   48% |    2.7% | 22.7% | 74.6% |      0% |    0% |  100% |
| bubble    | O0    |    5 |   90.1% |  0.2% |  9.7% |   85.1% |  7.7% |  7.2% |   78.6% | 17.7% |  3.7% |   69.4% | 28.3% |  2.3% |   61.2% | 37.9% |  0.9% |   54.1% | 45.7% |  0.2% |   39.6% | 60.4% |    0% |   29.9% | 70.1% |    0% |   26.8% | 73.2% |    0% |     23% |   77% |    0% |   14.3% | 85.7% |    0% |    5.5% | 94.5% |    0% |    1.5% | 98.5% |    0% |      0% |  100% |    0% |
| bubble    | O1    |    5 |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |
| bubble    | O2    |    5 |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |
| bubble    | O3    |    5 |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |
| bubble    | Ofast |    5 |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |
| insertion | Os    |    4 |     20% |    0% |   80% |   19.8% |    0% | 80.2% |   19.9% |  0.1% |   80% |   19.6% |  0.2% | 80.2% |   19.5% |  0.1% | 80.4% |   19.7% |    0% | 80.3% |   18.3% |  0.6% | 81.1% |   17.1% |  0.9% |   82% |   16.3% |  1.5% | 82.2% |   14.3% |  1.8% | 83.9% |    7.5% |  2.5% |   90% |    2.8% |  2.1% | 95.1% |    0.4% |  0.6% |   99% |      0% |    0% |  100% |
| insertion | O0    |    5 |   97.5% |  0.1% |  2.4% |   85.2% |    6% |  8.8% |   79.8% |  7.7% | 12.5% |   71.1% | 12.6% | 16.3% |   63.3% | 16.2% | 20.5% |   59.3% | 17.8% | 22.9% |   39.7% | 23.7% | 36.6% |   29.5% | 20.9% | 49.6% |   23.3% | 19.5% | 57.2% |   22.3% | 14.7% |   63% |     11% | 11.8% | 77.2% |    3.7% | 10.1% | 86.2% |    0.4% |    6% | 93.6% |      0% |    0% |  100% |
| insertion | O1    |    7 |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |
| insertion | O2    |    8 |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |
| insertion | O3    |    8 |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |
| insertion | Ofast |    8 |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |
| merge     | Os    |    7 |    6.8% |    0% | 93.2% |    7.4% |    0% | 92.6% |    7.4% |    0% | 92.6% |    7.4% |    0% | 92.6% |    7.4% |    0% | 92.6% |    6.4% |  0.1% | 93.5% |    5.7% |  0.1% | 94.2% |      5% |  0.2% | 94.8% |    4.1% |  0.2% | 95.7% |    3.7% |    1% | 95.3% |    3.2% |  1.1% | 95.7% |    1.3% |  0.8% | 97.9% |    0.3% |  0.6% | 99.1% |      0% |    0% |  100% |
| merge     | O0    |    7 |     20% |    0% |   80% |   19.9% |  0.1% |   80% |   19.9% |  0.2% | 79.9% |   19.9% |    0% | 80.1% |   19.8% |  0.1% | 80.1% |   19.8% |  0.4% | 79.8% |   18.7% |  0.9% | 80.4% |   18.5% |  1.5% |   80% |   16.8% |  2.5% | 80.7% |   16.3% |  2.1% | 81.6% |    9.8% |  8.5% | 81.7% |    3.9% | 11.1% |   85% |    0.4% |  2.4% | 97.2% |      0% |    0% |  100% |
| merge     | O1    |    8 |    6.8% |    0% | 93.2% |      7% |    0% |   93% |    7.2% |    0% | 92.8% |    7.3% |    0% | 92.7% |    7.3% |    0% | 92.7% |    6.6% |    0% | 93.4% |      6% |    0% |   94% |    4.8% |    0% | 95.2% |    3.4% |    0% | 96.6% |    3.5% |    0% | 96.5% |    2.3% |    0% | 97.7% |    0.8% |    0% | 99.2% |    0.5% |    0% | 99.5% |      0% |    0% |  100% |
| merge     | O2    |    9 |    6.8% |    0% | 93.2% |    7.3% |    0% | 92.7% |    7.3% |    0% | 92.7% |    7.1% |    0% | 92.9% |    6.8% |    0% | 93.2% |    6.8% |    0% | 93.2% |    6.1% |    0% | 93.9% |    4.5% |    0% | 95.5% |    3.8% |    0% | 96.2% |    3.9% |    0% | 96.1% |      2% |    0% |   98% |    1.3% |    0% | 98.7% |    0.6% |    0% | 99.4% |      0% |    0% |  100% |
| merge     | O3    |  194 |    6.8% |    0% | 93.2% |    7.3% |    0% | 92.7% |    7.3% |    0% | 92.7% |    7.3% |    0% | 92.7% |      7% |    0% |   93% |      7% |    0% |   93% |    5.6% |    0% | 94.4% |    4.7% |    0% | 95.3% |      4% |    0% |   96% |    3.4% |    0% | 96.6% |    2.1% |    0% | 97.9% |    0.6% |    0% | 99.4% |    0.2% |    0% | 99.8% |      0% |    0% |  100% |
| merge     | Ofast |  194 |    6.8% |    0% | 93.2% |    7.4% |    0% | 92.6% |    7.4% |    0% | 92.6% |    7.1% |    0% | 92.9% |    7.2% |    0% | 92.8% |    6.3% |    0% | 93.7% |    5.9% |    0% | 94.1% |    4.4% |    0% | 95.6% |    4.4% |    0% | 95.6% |    2.9% |    0% | 97.1% |    1.9% |    0% | 98.1% |    1.7% |    0% | 98.3% |    0.3% |    0% | 99.7% |      0% |    0% |  100% |
| quick     | Os    |    7 |   10.6% | 15.9% | 73.5% |     12% | 20.6% | 67.4% |   12.9% | 29.6% | 57.5% |     15% | 40.3% | 44.7% |   15.7% | 43.1% | 41.2% |     16% | 45.1% | 38.9% |   17.6% | 52.2% | 30.2% |     16% | 52.6% | 31.4% |   15.7% | 47.8% | 36.5% |   15.2% | 51.9% | 32.9% |     10% |   34% |   56% |    3.8% |  5.2% |   91% |    0.2% |    1% | 98.8% |      0% |    0% |  100% |
| quick     | O0    |    7 |    100% |    0% |    0% |   93.5% |  6.5% |    0% |   86.8% | 13.2% |    0% |   80.3% | 19.7% |    0% |   75.4% | 24.6% |    0% |     73% |   27% |    0% |   54.6% | 45.4% |    0% |   36.7% | 63.1% |  0.2% |   31.4% | 66.3% |  2.3% |   26.4% | 67.5% |  6.1% |   14.8% |   75% | 10.2% |    2.4% | 10.2% | 87.4% |      0% |  1.1% | 98.9% |      0% |    0% |  100% |
| quick     | O1    |    9 |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |
| quick     | O2    |   10 |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |
| quick     | O3    |   70 |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |
| quick     | Ofast |   70 |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |      0% |    9% |  0.4% |

*** TODO table fixes [3/5]
- [X] make percents
- [ ] include run cmps (broken out into reliable and un-reliable)
- [ ] graph
- [X] fail -> error
- [X] include "wrong"
- [ ] what's causing errors for non O0 optimization levels?
