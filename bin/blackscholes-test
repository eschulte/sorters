#!/bin/bash
#
# Usage: blackscholes-test EXECUTABLE [OPTIONS...]
#
# EXECUTABLE -- executable of blackscholes to test
#
# OPTIONS:
# -t,--test --- the specific test to run
#
#               default: run all tests and print the number of tests
#                        which passed.  If this is neutral, then exit
#                        with 0.
#
# -l,--limit -- optionally specify limit script
#
#               default: use the limit located next to this script
#
BASE="$(dirname $0)"
TEST=""
LIMIT="$BASE/limit"
declare -a INPUTS
declare -a OUTPUTS
HELP_TEXT=$(cat "$0" \
        |sed '/^[^#]/q' \
        |head -n -1 \
        |tail -n +3 \
        |sed -e :a -e '/^\n*$/{$d;N;ba' -e '}' \
        |cut -c3-)
if [ $(grep "\-h" <(echo "$1")) ];then echo "$HELP_TEXT"; exit 0; fi
PROG="$(dirname $1)/$(basename $1)"; shift;

eval set -- $(getopt -o ht:l: -l help,test:,limit: -- "$@" \
              || echo "$HELP_TEXT" && exit 1;)

while [ $# -gt 0 ];do
    case $1 in
        -h|--help)  echo "$HELP_TEXT" && exit 0;;
        -t|--test)  TEST="$2"; shift;;
        -l|--limit) LIMIT="$2"; shift;;
        (--) shift; break;;
        (-*) error "unrecognized option $1";;
        (*)  break;;
    esac
    shift
done

AWK_CMD=''
AWK_CMD+='function abs(x){return ((x < 0.0) ? -x : x)}'
AWK_CMD+='BEGIN{ diff=0; }'
AWK_CMD+='{ diff+=abs($1-$2); }'
AWK_CMD+='END { print diff }'
num_diff(){ # diff of numerical closeness
    paste $1 $2|awk "$AWK_CMD"; }

NEARNESS=0.00001
run(){ # return the difference between oracle and program output
    local DIFF=$(num_diff <($LIMIT $PROG <(echo "${INPUTS[$1]}")) <(echo "${OUTPUTS[$1]}"));
    [ $(echo "$DIFF < $NEARNESS"|bc) -eq 1 ]; }

INPUTS[0]="1
2
3
5
"
OUTPUTS[0]="1
2
3
4
"

INPUTS[1]="8
2
3
4
"
OUTPUTS[1]="8
2
3
4
"

# Actually run
if [ -z "$TEST" ];then
    count=0
    for i in $(seq 0 $((${#INPUTS[@]} - 1)));do
        if $(run $i);then count=$(($count + 1));fi
    done
    echo "$count"
    exit 0
else
    if $(run $TEST);then exit 0;fi
fi
exit 1
